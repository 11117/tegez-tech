<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEGEZ Ifi technikusi beoszt√°s</title>
    <style>
        /* --- ALAPOK --- */
        body { font-family: 'Segoe UI', sans-serif; background: #eceff1; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #263238; }
        #status { text-align: center; padding: 10px; font-weight: bold; color: #0288d1; }
        .table-wrapper { max-height: 70vh; overflow-y: auto; border: 1px solid #cfd8dc; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        
        /* --- ASZTALI N√âZET --- */
        th { background: #455a64; color: white; padding: 12px; position: sticky; top: 0; z-index: 10; font-size: 13px; }
        td { border: 1px solid #eceff1; padding: 8px; vertical-align: top; }
        .col-date { width: 10%; text-align: center; }
        .col-tech { width: 25%; }
        .col-comment { width: 30%; }
        .col-save { width: 10%; text-align: center; }

        .szombat { background: #fff9c4 !important; border-left: 5px solid #fbc02d; }
        .vasarnap { background: #fafafa; color: #c62828; }
        .today-highlight { outline: 4px solid #ff9800; background-color: #fff3e0 !important; }

        input, textarea { width: 100%; box-sizing: border-box; padding: 6px; margin-bottom: 4px; border: 1px solid #cfd8dc; border-radius: 4px; font-family: inherit; }
        .label { font-size: 10px; color: #78909c; font-weight: bold; display: block; }
        .auto-btn { background: #0288d1; color: white; border: none; padding: 8px; cursor: pointer; border-radius: 4px; width: 100%; font-weight: bold; margin-bottom: 5px; }
        .save-btn { background: #43a047; color: white; border: none; padding: 10px; cursor: pointer; width: 100%; border-radius: 6px; font-weight: bold; transition: background 0.3s; }
        .top-nav { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .today-btn { background: #ff9800; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* Mobilos √∂sszefoglal√≥ sz√∂veg (PC-n rejtett) */
        .mobile-info { display: none; font-size: 13px; color: #37474f; margin-top: 5px; }

        /* --- MOBIL OPTIMALIZ√ÅL√ÅS (768px alatt) --- */
        @media screen and (max-width: 768px) {
            .container { width: 100%; padding: 10px 5px; border-radius: 0; margin: 0; }
            thead { display: none; }
            tr { display: block; margin-bottom: 8px; border: 1px solid #cfd8dc; border-radius: 8px; background: #fff; padding: 10px; cursor: pointer; }
            td { display: block; width: 100% !important; border: none; padding: 0; box-sizing: border-box; }
            
            /* Rejtj√ºk a szerkeszt≈ë r√©szt, am√≠g nincs kinyitva */
            .input-wrapper, .auto-wrapper, .col-comment, .col-save { display: none; }
            
            /* Ha a sor akt√≠v (nyitott) */
            tr.active .input-wrapper, tr.active .auto-wrapper, tr.active .col-comment, tr.active .col-save { display: block; margin-top: 10px; }
            tr.active .mobile-info { display: none; } /* Nyitott √°llapotban ne zavarjon az √∂sszefoglal√≥ */
            
            .mobile-info { display: block; } /* Z√°rt √°llapotban l√°tjuk a neveket */
            .col-date { text-align: left; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
            
            input, textarea { font-size: 16px !important; padding: 12px; } /* iOS zoom fix */
            .save-btn { padding: 15px; margin-top: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h2>üìÖ Szolg√°lati Beoszt√°s</h2>
    <div id="status">Szinkroniz√°l√°s... K√©rlek v√°rj!</div>
    <div class="top-nav"><button class="today-btn" onclick="scrollToToday()">üìç Ugr√°s a mai naphoz</button></div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>D√°tum</th><th>Hangtechnikusok</th><th>Vet√≠t≈ës√∂k</th><th>Megjegyz√©s</th><th>Ment√©s</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbztV5Pb__eugYBb44EIrHYzZbxGpzND6ZKMO-SFeGCIs2HnRz3wDzTP7eMmJLJRYHsx/exec';

async function init() {
    generateCalendar();
    await loadData();
    setTimeout(scrollToToday, 500);
}

function generateCalendar() {
    const tbody = document.getElementById('tableBody');
    const ma = new Date();
    let html = "";
    for (let i = 0; i < 180; i++) {
        let d = new Date(); d.setDate(ma.getDate() + i);
        let iso = d.toISOString().split('T')[0];
        let nap = d.getDay();
        let cls = (nap === 6) ? "szombat" : (nap === 0 ? "vasarnap" : "");
        
        html += `<tr class="${cls}" id="row-${iso}" onclick="toggleRow(this)">
            <td class="col-date">
                <strong>${d.toLocaleDateString('hu-HU',{month:'short',day:'numeric'})}</strong> 
                <small>(${d.toLocaleDateString('hu-HU',{weekday:'short'})})</small>
                <div class="mobile-info" id="info-${iso}"><i>Erre a napra m√©g nincs beoszt√°s</i></div>
            </td>
            <td class="col-tech">
                <div class="auto-wrapper"><button class="auto-btn" onclick="event.stopPropagation(); autoFill('${iso}','hang')">‚ú® Auto Hangos√≠t√≥</button></div>
                <div class="input-wrapper">
                    <span class="label">F≈ë HANGOS√çT√ìüé§:</span>
                    <input id="h1-${iso}" oninput="updateInfo('${iso}')" onclick="event.stopPropagation()">
                </div>
                <div class="input-wrapper">
                    <span class="label">Tartal√©k HANGOS√çT√ìüé§:</span>
                    <input id="h2-${iso}" oninput="updateInfo('${iso}')" onclick="event.stopPropagation()">
                </div>
            </td>
            <td class="col-tech">
                <div class="auto-wrapper"><button class="auto-btn" onclick="event.stopPropagation(); autoFill('${iso}','vetito')">‚ú® Auto Vet√≠t≈ë</button></div>
                <div class="input-wrapper">
                    <span class="label">F≈ë VET√çT≈êüíª:</span>
                    <input id="v1-${iso}" oninput="updateInfo('${iso}')" onclick="event.stopPropagation()">
                </div>
                <div class="input-wrapper">
                    <span class="label">Tartal√©k VET√çT≈êüíª:</span>
                    <input id="v2-${iso}" oninput="updateInfo('${iso}')" onclick="event.stopPropagation()">
                </div>
            </td>
            <td class="col-comment">
                <textarea id="m-${iso}" placeholder="Megjegyz√©s... (pl: [Neved]: nem tudok j√∂nni)" onclick="event.stopPropagation()"></textarea>
            </td>
            <td class="col-save">
                <button class="save-btn" id="s-${iso}" onclick="event.stopPropagation(); saveRow('${iso}')">Ment√©s</button>
            </td>
        </tr>`;
    }
    tbody.innerHTML = html;
}

// Mobilos sor-nyit√°s kezel≈ë
function toggleRow(row) {
    if (window.innerWidth > 768) return; // PC-n ne csin√°ljon semmit
    const isActive = row.classList.contains('active');
    
    // Csak akkor z√°runk be mindent, ha √∫jat nyitunk ki
    if (!isActive) {
        document.querySelectorAll('tr').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
        setTimeout(() => {
            row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 200);
    } else {
        // Ha a m√°r nyitottra kattint (nem az inputra!), akkor becsukja
        row.classList.remove('active');
    }
}

// √ñsszegz≈ë friss√≠t√©se (tartal√©kosokkal)
function updateInfo(iso) {
    const h1 = document.getElementById(`h1-${iso}`).value.trim();
    const h2 = document.getElementById(`h2-${iso}`).value.trim();
    const v1 = document.getElementById(`v1-${iso}`).value.trim();
    const v2 = document.getElementById(`v2-${iso}`).value.trim();
    const infoBox = document.getElementById(`info-${iso}`);
    
    if (!infoBox) return;

    if (h1 || h2 || v1 || v2) {
        let hangResz = h1 + (h2 ? ` (${h2})` : "");
        let vetitoResz = v1 + (v2 ? ` (${v2})` : "");
        
        let szoveg = "";
        if (h1 || h2) szoveg += `üé§ ${hangResz} `;
        if (v1 || v2) szoveg += (szoveg ? " | " : "") + `üíª ${vetitoResz}`;
        
        infoBox.innerHTML = szoveg;
        infoBox.style.color = "#2e7d32";
        infoBox.style.fontStyle = "normal";
    } else {
        infoBox.innerHTML = "<i>Erre a napra m√©g nincs beoszt√°s</i>";
        infoBox.style.color = "#78909c";
    }
}

async function loadData() {
    try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        data.forEach((row, idx) => {
            if (idx === 0) return;
            let d = row[0];
            if(document.getElementById(`h1-${d}`)) {
                document.getElementById(`h1-${d}`).value = row[1]||""; 
                document.getElementById(`h2-${d}`).value = row[2]||"";
                document.getElementById(`v1-${d}`).value = row[3]||""; 
                document.getElementById(`v2-${d}`).value = row[4]||"";
                document.getElementById(`m-${d}`).value = row[5]||"";
                updateInfo(d); // Bet√∂lt√©skor is friss√≠tj√ºk a mobil n√©zetet
            }
        });
        document.getElementById('status').innerText = "‚úÖ Adatok bet√∂ltve.";
    } catch(e) { 
        document.getElementById('status').innerText = "‚ö†Ô∏è Hiba a bet√∂lt√©sn√©l."; 
    }
}

async function autoFill(iso, tipus) {
    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "‚è≥..."; btn.disabled = true;
    try {
        const res = await fetch(scriptURL + "?action=getAutoBeosztas");
        const data = await res.json();
        let lista = (tipus === 'hang') ? (data.hangLista || []) : (data.vetitoLista || []);
        let busy = [document.getElementById(`h1-${iso}`).value, document.getElementById(`h2-${iso}`).value, 
                    document.getElementById(`v1-${iso}`).value, document.getElementById(`v2-${iso}`).value].filter(n => n);
        let talalt = [];
        for (let n of lista) { if(!busy.includes(n)) talalt.push(n); if(talalt.length === 2) break; }
        
        if(tipus === 'hang') {
            document.getElementById(`h1-${iso}`).value = talalt[0] || "";
            document.getElementById(`h2-${iso}`).value = talalt[1] || "";
        } else {
            document.getElementById(`v1-${iso}`).value = talalt[0] || "";
            document.getElementById(`v2-${iso}`).value = talalt[1] || "";
        }
        updateInfo(iso);
    } catch(e) { alert("Hiba az auto-kit√∂lt√©sn√©l!"); }
    btn.innerText = originalText; btn.disabled = false;
}

async function saveRow(iso) {
    const h1v = document.getElementById(`h1-${iso}`).value.trim();
    const h2v = document.getElementById(`h2-${iso}`).value.trim();
    const v1v = document.getElementById(`v1-${iso}`).value.trim();
    const v2v = document.getElementById(`v2-${iso}`).value.trim();
    const n = [h1v, h2v, v1v, v2v].filter(x => x!=="");
    
    if(new Set(n).size !== n.length) { alert("‚ùå Hiba: Egy n√©v csak egyszer szerepelhet!"); return; }
    
    const btn = document.getElementById(`s-${iso}`);
    const originalBg = btn.style.background;
    btn.innerText = "‚è≥ Ment√©s..."; btn.disabled = true;

    const payload = { datum: iso, h1: h1v, h2: h2v, v1: v1v, v2: v2v, m: document.getElementById(`m-${iso}`).value };
    
    try {
        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        btn.innerText = "‚úÖ K√âSZ";
        btn.style.background = "#43a047";
        updateInfo(iso);
        setTimeout(() => { 
            btn.innerText = "Ment√©s"; 
            btn.disabled = false;
            btn.style.background = originalBg;
            if (window.innerWidth <= 768) {
                document.getElementById(`row-${iso}`).classList.remove('active'); // Mobilon ment√©s ut√°n becsukjuk
            }
        }, 1500);
    } catch(e) { 
        alert("Hiba a ment√©s sor√°n!"); 
        btn.innerText = "Ment√©s"; 
        btn.disabled = false; 
    }
}

function scrollToToday() {
    const d = new Date().toISOString().split('T')[0];
    const r = document.getElementById(`row-${d}`);
    if(r) { 
        r.classList.add('today-highlight'); 
        r.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
    }
}
window.onload = init;
</script>
</body>
</html>